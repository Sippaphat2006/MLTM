<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CNC1 Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f0f0f0; height:100vh; overflow:hidden; }
  .container { display:flex; height:100vh; flex-direction:row; }
  .sidebar { background:#787878; width:180px; display:flex; flex-direction:column; justify-content:space-around; align-items:center; padding:10px 0; }
  .menu-item { flex:1; width:100%; display:flex; justify-content:center; align-items:center; cursor:pointer; transition:background 0.2s; font-size:16px; }
  .menu-item:hover { background:#454545; }
  .dashboard { flex:1; padding:20px; display:flex; flex-direction:column; gap:15px; height:100%; box-sizing:border-box; overflow:hidden; }
  .top-row { display:flex; gap:15px; flex-wrap:wrap; align-items:flex-start; }
  .date-picker { background:white; padding:10px 15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); max-width:300px; }
  .date-picker label { margin-right:10px; font-weight:bold; }
  input[type="date"] { padding:5px 10px; border-radius:5px; border:1px solid #ccc; }
  .chart-container { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); flex:1; display:flex; flex-direction:column; justify-content:center; min-height:160px; }
  .line-status-row { display:flex; gap:15px; flex:1; min-height:240px; }
  .status-box { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center; justify-content:center; min-width:120px; }
  .status-circle { width:40px; height:40px; border-radius:50%; background:#9e9e9e; margin-top:10px; }
  .dashboard-charts { display:flex; gap:15px; flex:1; overflow:hidden; }
  .dashboard-charts .pie-wrapper { flex:0.8; display:flex; align-items:center; justify-content:center; }
  .dashboard-charts .pie-wrapper canvas { max-width:100% !important; max-height:100% !important; }
  .dashboard-charts .other-charts { flex:2; display:flex; gap:15px; }
  .summary-text { margin-top:10px; text-align:center; font-size:14px; line-height:1.4; }
  .muted { color:#777; font-size:12px; margin-top:6px; }
  .error { color:#c62828; font-size:12px; margin-top:6px; }
  @media (max-width: 768px) {
    .container { flex-direction:column; }
    .sidebar { flex-direction:row; width:100%; height:auto; }
    .menu-item { flex:1; padding:15px 0; font-size:14px; }
    .top-row { flex-direction:column; }
    .line-status-row { flex-direction:column; }
    .date-picker { max-width:100%; }
    .dashboard-charts { flex-direction:column; }
  }
</style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="menu-item" onclick="location.href='cnc1.html'">CNC1</div>
    <div class="menu-item" onclick="location.href='cnc2.html'">CNC2</div>
    <div class="menu-item" onclick="location.href='cnc3.html'">CNC3</div>
    <div class="menu-item" onclick="location.href='cnc4.html'">CNC4</div>
  </aside>

  <main class="dashboard">
    <div class="top-row">
      <div class="date-picker">
        <label for="dateSelect">Select Date:</label>
        <input type="date" id="dateSelect">
        <div id="infoMsg" class="muted"></div>
        <div id="errorMsg" class="error"></div>
      </div>
      <div class="line-status-row">
        <div class="chart-container" style="flex:3; min-width:250px; margin-right:10px;">
          <canvas id="lineChart"></canvas>
        </div>
        <div class="status-box" style="flex:0.7;">
          <h4>Current Status</h4>
          <div id="towerStatus" class="status-circle" title="Live machine status"></div>
          <div id="statusText" class="muted"></div>
        </div>
      </div>
    </div>

    <div class="dashboard-charts">
      <div class="chart-container pie-wrapper">
        <canvas id="pieChart"></canvas>
      </div>
      <div class="other-charts">
        <div class="chart-container" style="flex:1.5;">
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-container" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
          <canvas id="summaryChart" style="max-width:150px; max-height:150px;"></canvas>
          <div id="summaryText" class="summary-text"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/* ===========================
   CONFIG — EDIT THESE
   =========================== */
const API_BASE     = 'http://192.168.0.124:3000/api'; // ← เปลี่ยนให้ตรงกับ backend
const API_KEY      = '';
const MACHINE_CODE = 'CNC4'; // ← เครื่องของหน้านี้ (ตรงกับ machines.code)

/* ===========================
   COLOR (exactly 3 colors)
   =========================== */
const AllowedColors = ['green','yellow','red'];
let Colors = {
  green: '#4CAF50',
  yellow:'#FFC107',
  red:   '#F44336'
};

/* ===========================
   HELPERS
   =========================== */
async function fetchJSON(path) {
  const url = path.startsWith('http') ? path : `${API_BASE}${path}`;
  const headers = { 'Content-Type': 'application/json' };
  if (API_KEY) headers['x-api-key'] = API_KEY;
  const res = await fetch(url, { headers });
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return res.json();
}
function toYMDLocal(d = new Date()) {
  const dt = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return dt.toISOString().slice(0,10);
}
function startOfWeekSunday(d = new Date()) {
  const x = new Date(d);
  x.setHours(0,0,0,0);
  x.setDate(x.getDate() - x.getDay()); // 0=Sun
  return x;
}
function round2(n){ return Math.round(n*100)/100; }
function hex2rgba(hex, alpha){
  const h = hex.replace('#','');
  const bigint = parseInt(h,16);
  const r=(bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
  return `rgba(${r},${g},${b},${alpha})`;
}
function normalizeColor(c){
  const s = String(c || '').toLowerCase().trim();
  if (s === 'amber') return 'yellow';
  if (s === 'g') return 'green';
  if (s === 'y') return 'yellow';
  if (s === 'r') return 'red';
  return AllowedColors.includes(s) ? s : 'unknown';
}

function pad2(n){ return String(n).padStart(2,'0'); }
function secToHMS(sec){
  const s = Math.max(0, Math.floor(sec));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s % 60;
  return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
}
function hrsToHMS(hours){ return secToHMS(Math.round(Number(hours||0)*3600)); }


/* ===========================
   API WRAPPERS (stick to router)
   =========================== */
async function apiGetColors(){
  try{
    const rows = await fetchJSON('/colors'); // [{id,name,hex}, ...]
    for (const r of rows || []) {
      const name = normalizeColor(r.name);
      if (AllowedColors.includes(name) && r.hex) {
        Colors[name] = r.hex;
      }
    }
  }catch(e){ /* keep defaults if /colors not available */ }
}
async function apiGetCurrent(code){
  // GET /machines/:code/status/current -> {color, ...}
  return fetchJSON(`/machines/${encodeURIComponent(code)}/status/current`);
}
async function apiGetDailyBuckets(code, dateYMD){
  const rows = await fetchJSON(`/machines/${encodeURIComponent(code)}/status/by-date?date=${encodeURIComponent(dateYMD)}`);
  const sec = { green:0, yellow:0, red:0 };
  for (const r of rows || []) {
    const c = normalizeColor(r.color);
    if (AllowedColors.includes(c)) sec[c] += Number(r.seconds || 0);
  }
  return {
    seconds: { ...sec },
    hours: {
      green: round2(sec.green/3600),
      yellow: round2(sec.yellow/3600),
      red:   round2(sec.red/3600),
    }
  };
}
async function apiGetWeekly(code, weekStartYMD){
  // GET /machines/:code/status/weekly?week_start=YYYY-MM-DD
  const out = await fetchJSON(`/machines/${encodeURIComponent(code)}/status/weekly?week_start=${encodeURIComponent(weekStartYMD)}`);
  const green=[], yellow=[], red=[];
  for (const day of (out || [])){
    let g=0,y=0,r=0;
    for (const b of (day.buckets || [])){
      const c = normalizeColor(b.color);
      const s = Number(b.seconds || 0);
      if (c==='green')  g = s;
      if (c==='yellow') y = s;
      if (c==='red')    r = s;
    }
    green.push(round2(g/3600));
    yellow.push(round2(y/3600));
    red.push(round2(r/3600));
  }
  return { green, yellow, red, labels: (out || []).map(d => d.date) };
}

/* ===========================
   CHARTS
   =========================== */
const weeklyLabels = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

const lineChart = new Chart(document.getElementById('lineChart').getContext('2d'), {
  type:'line',
  data:{
    labels: weeklyLabels,
    datasets:[
      { label:'Green',  data:[0,0,0,0,0,0,0], borderColor:Colors.green,  backgroundColor:hex2rgba(Colors.green,0.2), tension:0.3 },
      { label:'Yellow', data:[0,0,0,0,0,0,0], borderColor:Colors.yellow, backgroundColor:hex2rgba(Colors.yellow,0.2), tension:0.3 },
      { label:'Red',    data:[0,0,0,0,0,0,0], borderColor:Colors.red,    backgroundColor:hex2rgba(Colors.red,0.2), tension:0.3 }
    ]
  },
  options:{
    responsive:true,
    plugins:{ 
      legend:{ position:'top' }, 
      title:{ display:true, text:'Tower Light Hours per Week' },
      tooltip:{
        callbacks:{
          label:(ctx)=>{
            const hours = ctx.parsed.y;
            return `${ctx.dataset.label}: ${hrsToHMS(hours)} (${hours.toFixed(2)} h)`;
          }
        }
      }
    },
    scales:{
      y:{ beginAtZero:true, max:24, ticks:{ stepSize:2 }, title:{ display:true, text:'Hours'} },
      x:{ title:{ display:true, text:'Day of Week'} }
    }
  }
});

const pieChart = new Chart(document.getElementById('pieChart').getContext('2d'), {
  type:'pie',
  data:{ labels:['Green','Yellow','Red'], datasets:[{ data:[0,0,0], backgroundColor:[Colors.green,Colors.yellow,Colors.red], hoverOffset:4 }]},
  options:{ 
    responsive:true, 
    plugins:{ 
      legend:{ position:'top' },
      title:{ display:true, text:'Tower Light Daily Distribution'},
      tooltip:{
        callbacks:{
          label: (ctx)=>{
            const label = ctx.label || '';
            const hours = ctx.parsed;      // ค่าที่ใส่ลงกราฟ (ชั่วโมง)
            return `${label}: ${hrsToHMS(hours)} (${hours.toFixed(2)} h)`;
          }
        }
      }
    }
  }
});

const barChart = new Chart(document.getElementById('barChart').getContext('2d'), {
  type:'bar',
  data:{ labels:['Green','Yellow','Red'], datasets:[{ label:'Hours', data:[0,0,0], backgroundColor:[Colors.green,Colors.yellow,Colors.red] }]},
  options:{ 
    responsive:true, 
    plugins:{ 
      legend:{ display:false }, 
      title:{ display:true, text:'Tower Light Hours by Color'},
      tooltip:{
        callbacks:{
          label:(ctx)=>{
            const hours = ctx.raw;
            return `${ctx.label}: ${hrsToHMS(hours)} (${hours.toFixed(2)} h)`;
          }
        }
      }
    },
    scales:{ y:{ beginAtZero:true, max:24, ticks:{ stepSize:2 }, title:{ display:true, text:'Hours'} }, x:{ title:{ display:true, text:'Color'} } } }
});

const summaryChart = new Chart(document.getElementById('summaryChart').getContext('2d'), {
  type:'doughnut',
  data:{ labels:['Green','Yellow','Red'], datasets:[{ data:[0,0,0], backgroundColor:[Colors.green,Colors.yellow,Colors.red], borderWidth:0 }]},
  options:{ responsive:true, cutout:'70%', plugins:{ legend:{ display:false }, tooltip:{ enabled:false } } }
});

/* ===========================
   UI UPDATERS
   =========================== */
function applyThemeColors(){
  const g=Colors.green, y=Colors.yellow, r=Colors.red;
  lineChart.data.datasets[0].borderColor = g;
  lineChart.data.datasets[0].backgroundColor = hex2rgba(g,0.2);
  lineChart.data.datasets[1].borderColor = y;
  lineChart.data.datasets[1].backgroundColor = hex2rgba(y,0.2);
  lineChart.data.datasets[2].borderColor = r;
  lineChart.data.datasets[2].backgroundColor = hex2rgba(r,0.2);
  pieChart.data.datasets[0].backgroundColor = [g,y,r];
  barChart.data.datasets[0].backgroundColor = [g,y,r];
  summaryChart.data.datasets[0].backgroundColor = [g,y,r];
  lineChart.update(); pieChart.update(); barChart.update(); summaryChart.update();
}
function updateSummaryWidgetSeconds(secGreen, secYellow, secRed){
  const total = secGreen + secYellow + secRed;
  const percent = total>0 ? ((secGreen/total)*100).toFixed(1) : 0;

  summaryChart.data.datasets[0].data = [
    round2(secGreen/3600), round2(secYellow/3600), round2(secRed/3600)
  ];
  summaryChart.update();

  document.getElementById('summaryText').innerHTML =
    `<div style="font-size:20px;font-weight:bold; margin-bottom:5px;">${percent}%</div>
     <div>● <span style="color:${Colors.green}">Green</span>: ${secToHMS(secGreen)}</div>
     <div>● <span style="color:${Colors.yellow}">Yellow</span>: ${secToHMS(secYellow)}</div>
     <div>● <span style="color:${Colors.red}">Red</span>: ${secToHMS(secRed)}</div>`;
}

function updateDailyCharts(daily){
  // กราฟยังใช้ "ชั่วโมง"
  pieChart.data.datasets[0].data = [daily.hours.green,daily.hours.yellow,daily.hours.red];
  pieChart.update();
  barChart.data.datasets[0].data = [daily.hours.green,daily.hours.yellow,daily.hours.red];
  barChart.update();

  // ข้อความสรุปโชว์ HH:MM:SS
  updateSummaryWidgetSeconds(daily.seconds.green, daily.seconds.yellow, daily.seconds.red);
}

function updateWeeklyCharts(weekly){
  lineChart.data.datasets[0].data = weekly.green;
  lineChart.data.datasets[1].data = weekly.yellow;
  lineChart.data.datasets[2].data = weekly.red;
  lineChart.update();
}
function updateTowerStatus(color, label=''){
  const el = document.getElementById('towerStatus');
  const txt = document.getElementById('statusText');
  const c = normalizeColor(color);
  const map = { green:Colors.green, yellow:Colors.yellow, red:Colors.red, unknown:'#9e9e9e' };
  el.style.background = map[c] || map.unknown;
  txt.textContent = label || (AllowedColors.includes(c) ? c.toUpperCase() : '');
}

/* ===========================
   LOADERS
   =========================== */
async function loadDaily(dateYMD){
  const errorBox = document.getElementById('errorMsg');
  errorBox.textContent = '';
  try {
    const daily = await apiGetDailyBuckets(MACHINE_CODE, dateYMD);
    updateDailyCharts(daily);
  } catch (e) {
    errorBox.textContent = `Failed to load daily data: ${e.message}`;
  }
}
async function loadWeekly(anchorDateYMD){
  const errorBox = document.getElementById('errorMsg');
  errorBox.textContent = '';
  try {
    const d = new Date(anchorDateYMD);
    const weekStart = startOfWeekSunday(d);
    const ymd = toYMDLocal(weekStart);
    const weekly = await apiGetWeekly(MACHINE_CODE, ymd);
    updateWeeklyCharts(weekly);
  } catch (e) {
    errorBox.textContent = `Failed to load weekly data: ${e.message}`;
  }
}
let liveTimer = null;
async function startLivePoll(){
  if (liveTimer) clearInterval(liveTimer);
  const task = async () => {
    try {
      const cur = await apiGetCurrent(MACHINE_CODE);
      const col = normalizeColor(cur && cur.color);
      updateTowerStatus(col, 'Live');
    } catch (e) {
      document.getElementById('errorMsg').textContent = `Live update failed: ${e.message}`;
    }
  };
  await task();
  liveTimer = setInterval(task, 10000); // 10s
}

/* ===========================
   DATE PICKER + BOOT
   =========================== */
const dateInput = document.getElementById('dateSelect');
const infoMsg = document.getElementById('infoMsg');
(function initDate(){
  const today = toYMDLocal(new Date());
  dateInput.value = today;
  infoMsg.textContent = `Showing data for ${today}`;
})();
dateInput.addEventListener('change', async (e)=>{
  const ymd = e.target.value;
  infoMsg.textContent = `Showing data for ${ymd}`;
  await loadDaily(ymd);
  await loadWeekly(ymd);
});
(async function boot(){
  try { await apiGetColors(); applyThemeColors(); } catch(e){}
  const today = toYMDLocal(new Date());
  await loadDaily(today);
  await loadWeekly(today);
  await startLivePoll();
})();
</script>
</body>
</html>

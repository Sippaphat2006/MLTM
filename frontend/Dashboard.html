<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Factory Dashboard – CNC1–CNC4</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { --bg:#f4f6f8; --panel:#fff; --muted:#6b7280; --ring:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);height:100vh;display:flex}

  /* LEFT TABS */
  .sidebar{background:#2f2f2f;color:#fff;width:260px;display:flex;flex-direction:column;padding:16px 14px;gap:14px}
  .brand{font-weight:800;letter-spacing:.4px}
  .tabs{display:flex;flex-direction:column;gap:10px;margin-top:6px}
  .tab{
    background:#3e3e3e;border:none;color:#fff;padding:12px 12px;border-radius:14px;cursor:pointer;
    display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:16px;
    transition:transform .05s ease,background .2s ease
  }
  .tab:hover{background:#4a4a4a}
  .tab.active{background:#1f1f1f;box-shadow:0 0 0 2px #555 inset}
  .tab .title{flex:1;text-align:left}
  .dot{width:14px;height:14px;border-radius:50%;background:#9ca3af;flex:0 0 auto}

  /* preview at bottom of sidebar */
  .preview{ margin-top:auto; background:#1f1f1f; border-radius:12px; padding:10px; text-align:center }
  .preview img{ width:100%; border-radius:10px; display:block }
  .preview .cap{ color:#ddd; font-size:14px; margin-top:6px }

  /* MAIN COLUMN */
  .main{flex:1;display:flex;flex-direction:column;gap:16px;padding:16px;overflow:auto}
  .panel{background:var(--panel);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:14px;height:100%}
  .muted{color:var(--muted);font-size:12px;margin-top:6px}
  .error{color:#c62828;font-size:12px;margin-top:6px}

  /* TOP: date picker | line chart | status */
  .top-grid{
    display:grid;
    grid-template-columns:320px 1fr 260px;
    gap:16px;
    align-items:stretch;
  }
  @media (max-width: 1100px){ .top-grid{grid-template-columns:1fr} }

  .datebox label{font-weight:700;margin-right:8px}
  .datebox input[type="date"]{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;width:100%}

  /* status fits blank space and scales light */
  .status{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:180px;height:100%}
  .circle{
    width: clamp(48px, 40%, 120px);
    aspect-ratio:1/1;border-radius:50%;
    background:#9e9e9e;margin-top:10px;box-shadow:0 0 0 4px var(--ring)
  }
  .status h4{margin:0 0 6px 0}

  /* chart containers */
  .chart-panel{position:relative;height:380px}
  .panel canvas:not(#summaryChart){ width:100% !important; display:block }

  .bottom-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  @media (max-width: 1280px){ .bottom-grid{grid-template-columns:1fr} }

  /* summary donut: smaller & responsive */
  .summaryBox{display:flex;align-items:center;justify-content:center;flex-direction:column}
  .summaryBox canvas{
    width: clamp(110px, 16vw, 170px) !important;
    height: clamp(110px, 16vw, 170px) !important;
  }
</style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">OKUMA Dashboard</div>
    <div class="tabs" id="machineTabs"></div>

    <!-- big preview of the selected machine -->
    <div class="preview" id="machinePreview">
      <img id="machinePreviewImg" alt="">
      <div class="cap" id="machinePreviewCaption">Machine photo</div>
    </div>
  </aside>

  <main class="main">
    <div class="top-grid">
      <section class="panel datebox">
        <label for="datePick">Select Date</label>
        <input type="date" id="datePick" />
        <div id="info" class="muted" style="margin-top:8px"></div>
        <div id="err" class="error"></div>
      </section>

      <section class="panel chart-panel">
        <canvas id="lineChart"></canvas>
      </section>

      <section class="panel status">
        <h4>Current Status</h4>
        <div id="statusCircle" class="circle"></div>
        <div id="statusText" class="muted">Live</div>
      </section>
    </div>

    <div class="bottom-grid">
      <section class="panel chart-panel">
        <canvas id="pieChart"></canvas>
      </section>
      <section class="panel chart-panel">
        <canvas id="barChart"></canvas>
      </section>
      <section class="panel summaryBox">
        <canvas id="summaryChart"></canvas>
        <div id="summaryText" style="text-align:center;margin-top:10px;font-size:14px"></div>
      </section>
    </div>
  </main>

<script>
/* ===== CONFIG ===== */
const API_BASE = 'http://192.168.0.145:3000/api';
const API_KEY  = '';
// derive the server origin for static assets (works even when page is opened via file://)
const SERVER_ORIGIN = API_BASE.replace(/\/api\/?$/,'');

let MACHINES = [];                 // filled from /api/machines
let MACHINE_META = {};             // { code -> {code,name} }
let ACTIVE = null;

/* 1s polling everywhere */
const POLL_MS = 1000;

/* ===== PERSISTENCE (URL + localStorage) ===== */
const STORE_KEYS = { machine:'mltm.activeMachine', date:'mltm.date' };

function toYMDLocal(d=new Date()){
  const t=new Date(d.getTime()-d.getTimezoneOffset()*60000);
  return t.toISOString().slice(0,10);
}

function readStateFromURL(){
  const p = new URLSearchParams(location.search);
  const m = p.get('m');
  const d = p.get('d');
  return { m, d };
}

function writeStateToURL(m, d){
  const p = new URLSearchParams(location.search);
  if (m) p.set('m', m); else p.delete('m');
  if (d) p.set('d', d); else p.delete('d');
  const newUrl = `${location.pathname}?${p.toString()}`;
  history.replaceState(null, '', newUrl);
}

function loadState(){
  const { m, d } = readStateFromURL();
  if (m && MACHINES.includes(m)) ACTIVE = m;
  const today = toYMDLocal(new Date());
  if (d && /^\d{4}-\d{2}-\d{2}$/.test(d)) datePick.value = d;
  else datePick.value = (localStorage.getItem(STORE_KEYS.date) || today);

  if (!m) {
    const savedM = localStorage.getItem(STORE_KEYS.machine);
    if (savedM && MACHINES.includes(savedM)) ACTIVE = savedM;
  }
  writeStateToURL(ACTIVE, datePick.value);
}

function saveState(){
  localStorage.setItem(STORE_KEYS.machine, ACTIVE);
  localStorage.setItem(STORE_KEYS.date, datePick.value);
  writeStateToURL(ACTIVE, datePick.value);
}

/* ===== COLORS (3 only) ===== */
const AllowedColors = ['green','yellow','red'];
let Colors = { green:'#4CAF50', yellow:'#FFC107', red:'#F44336' };

/* ===== HELPERS ===== */
function withTs(path){ return path + (path.includes('?') ? '&' : '?') + `_ts=${Date.now()}`; }
async function fetchJSON(path, opt = {}){
  const url = path.startsWith('http') ? path : `${API_BASE}${withTs(path)}`;
  const headers = { 'Content-Type':'application/json' };
  if (API_KEY) headers['x-api-key']=API_KEY;
  const res = await fetch(url,{ headers, cache:'no-store', signal: opt.signal });
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return res.json();
}
function startOfWeekSunday(d=new Date()){ const x=new Date(d); x.setHours(0,0,0,0); x.setDate(x.getDate()-x.getDay()); return x; }
function round2(n){ return Math.round(n*100)/100; }
function normalizeColor(c){
  const s = String(c||'').toLowerCase().trim();
  if (s==='amber') return 'yellow';
  if (s==='g') return 'green';
  if (s==='y') return 'yellow';
  if (s==='r') return 'red';
  if (s==='unknown') return 'unknown';
  return ['green','yellow','red'].includes(s) ? s : 'unknown';
}
function pad2(n){ return String(n).padStart(2,'0'); }
function secToHMS(sec){ const s=Math.max(0,Math.floor(sec)); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), S=s%60; return `${pad2(h)}:${pad2(m)}:${pad2(S)}`; }
function hrsToHMS(h){ return secToHMS(Math.round(Number(h||0)*3600)); }
function rgba(hex,a){ const h=hex.replace('#',''); const n=parseInt(h,16); const R=(n>>16)&255,G=(n>>8)&255,B=n&255; return `rgba(${R},${G},${B},${a})`; }

/* ===== API (router) ===== */
async function apiGetColors(){ try{ const rows=await fetchJSON('/colors'); for(const r of rows||[]){ const n=normalizeColor(r.name); if(AllowedColors.includes(n)&&r.hex) Colors[n]=r.hex; } }catch(e){} }
async function apiGetCurrent(code, opt){ return fetchJSON(`/machines/${encodeURIComponent(code)}/status/current`, opt); }
async function apiGetDaily(code, ymd, opt){
  const rows = await fetchJSON(`/machines/${encodeURIComponent(code)}/status/by-date?date=${encodeURIComponent(ymd)}`, opt);
  const sec = {green:0,yellow:0,red:0};
  for(const r of rows||[]){ const c=normalizeColor(r.color); if(AllowedColors.includes(c)) sec[c]+=Number(r.seconds||0); }
  return { seconds:sec, hours:{ green:round2(sec.green/3600), yellow:round2(sec.yellow/3600), red:round2(sec.red/3600) } };
}
async function apiGetWeekly(code, weekStartYMD, opt){
  const out = await fetchJSON(`/machines/${encodeURIComponent(code)}/status/weekly?week_start=${encodeURIComponent(weekStartYMD)}`, opt);
  const g=[],y=[],r=[];
  for(const d of out||[]){
    let sg=0,sy=0,sr=0;
    for(const b of d.buckets||[]){ const c=normalizeColor(b.color), s=Number(b.seconds||0); if(c==='green') sg=s; if(c==='yellow') sy=s; if(c==='red') sr=s; }
    g.push(round2(sg/3600)); y.push(round2(sy/3600)); r.push(round2(sr/3600));
  }
  return {green:g,yellow:y,red:r,labels:(out||[]).map(x=>x.date)};
}
/* Overview Today (all machines) — only for coloring tabs */
async function apiGetOverviewToday(opt){
  const res = await fetchJSON('/overview/today', opt);
  const map = {};
  for(const item of (res.overview||[])){
    const code = item?.machine?.code || item?.machine_code || item?.CODE || '';
    if(!code) continue;
    const currentColor = normalizeColor(item?.current?.color);
    const sec = { green:0, yellow:0, red:0 };
    for(const b of (item?.buckets||[])){ const c = normalizeColor(b.color); if(AllowedColors.includes(c)) sec[c]+=Number(b.seconds||0); }
    map[code] = {
      name: item?.machine?.name || item?.NAME || code,
      currentColor,
      seconds: sec,
      hours: { green:round2(sec.green/3600), yellow:round2(sec.yellow/3600), red:round2(sec.red/3600) }
    };
  }
  return { date: res.date, byCode: map };
}

/* ===== Machines (names + images) ===== */
async function apiGetMachines(){
  try{
    const rows = await fetchJSON('/machines'); // expect {code,name} or {CODE,NAME}
    MACHINES = (rows||[])
      .map(r => r.code || r.CODE || r.machine_code || r.MACHINE_CODE || r.Code)
      .filter(Boolean);
    MACHINE_META = {};
    (rows||[]).forEach(r => {
      const code = r.code || r.CODE || r.machine_code || r.MACHINE_CODE || r.Code;
      const name = r.name || r.NAME || r.machine_name || r.MACHINE_NAME || r.Name || code;
      if (code) MACHINE_META[code] = { code, name };
    });
    if (!ACTIVE) ACTIVE = MACHINES[0] || null;
  }catch(e){
    // Fallback if endpoint not available
    MACHINES = ['CNC1','CNC2','CNC3','CNC4'];
    MACHINE_META = { CNC1:{code:'CNC1',name:'OKUMA 14'}, CNC2:{code:'CNC2',name:'OKUMA 15'}, CNC3:{code:'CNC3',name:'OKUMA 16'}, CNC4:{code:'CNC4',name:'OKUMA 17'} };
    if (!ACTIVE) ACTIVE = 'CNC1';
  }
}

function machineName(code){
  return (MACHINE_META[code]?.name) || code;
}

// Build image url from NAME like "OKUMA 14" → "OKUMA CNC machine 14.jpg"
// IMPORTANT: use the server origin so it works when the page is opened via file://
function imagePathFor(code){
  const name = machineName(code) || '';
  const m = String(name).match(/\d+/);
  const n = m ? m[0] : ({CNC1:14,CNC2:15,CNC3:16,CNC4:17}[code]);
  const file = n ? `OKUMA CNC machine ${n}.jpg` : `OKUMA CNC machine 14.jpg`;
  return `${SERVER_ORIGIN}/assets/machines/${encodeURIComponent(file)}`;
}

/* ===== TABS ===== */
const tabs = document.getElementById('machineTabs');

function updatePreview(code){
  const img = document.getElementById('machinePreviewImg');
  const cap = document.getElementById('machinePreviewCaption');
  cap.textContent = machineName(code);
  img.onload = () => { /* keep caption as name */ };
  img.onerror = () => { cap.textContent = 'No photo'; };
  img.src = imagePathFor(code);
}

function renderTabs(statusMap = {}){
  tabs.innerHTML='';
  MACHINES.forEach(code=>{
    const btn=document.createElement('button');
    btn.className='tab'+(code===ACTIVE?' active':'');
    btn.innerHTML = `
      <span class="title">${machineName(code)}</span>
      <span class="dot"></span>
    `;
    const dot = btn.querySelector('.dot');
    const col = statusMap[code]; if(col) dot.style.background=(Colors[col]||'#9e9e9e');

    btn.onclick=()=>{
      ACTIVE=code;
      [...tabs.children].forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      updatePreview(code);
      saveState();
      manualRefreshAndRestart();
    };
    tabs.appendChild(btn);
  });
  if (ACTIVE) updatePreview(ACTIVE);
}

/* ===== DATE PICKER ===== */
const datePick = document.getElementById('datePick');
const info     = document.getElementById('info');
const errBox   = document.getElementById('err');

datePick.addEventListener('change', ()=>{
  saveState();
  manualRefreshAndRestart();
});

/* ===== CHARTS ===== */
const lineChart = new Chart(document.getElementById('lineChart').getContext('2d'),{
  type:'line',
  data:{
    labels:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
    datasets:[
      { label:'Green',  data:Array(7).fill(0), borderColor:Colors.green,  backgroundColor:rgba(Colors.green,0.2), tension:0.3 },
      { label:'Yellow', data:Array(7).fill(0), borderColor:Colors.yellow, backgroundColor:rgba(Colors.yellow,0.2), tension:0.3 },
      { label:'Red',    data:Array(7).fill(0), borderColor:Colors.red,    backgroundColor:rgba(Colors.red,0.2),    tension:0.3 }
    ]
  },
  options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{ position:'top' },
      title:{ display:true, text:'Tower Light Hours per Week' },
      tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${hrsToHMS(ctx.parsed.y)} (${ctx.parsed.y.toFixed(2)} h)` } }
    },
    scales:{ y:{ beginAtZero:true, max:24, ticks:{ stepSize:2 }, title:{ display:true, text:'Hours'} },
             x:{ title:{ display:true, text:'Day of Week'} } }
  }
});
const pieChart = new Chart(document.getElementById('pieChart').getContext('2d'),{
  type:'pie',
  data:{ labels:['Green','Yellow','Red'], datasets:[{ data:[0,0,0], backgroundColor:[Colors.green,Colors.yellow,Colors.red]}]},
  options:{ responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{ position:'top' }, title:{ display:true, text:'Daily Distribution'},
    tooltip:{ callbacks:{ label:(ctx)=>`${ctx.label}: ${hrsToHMS(ctx.parsed)} (${ctx.parsed.toFixed(2)} h)`}}}}
});
const barChart = new Chart(document.getElementById('barChart').getContext('2d'),{
  type:'bar',
  data:{ labels:['Green','Yellow','Red'], datasets:[{ label:'Hours', data:[0,0,0], backgroundColor:[Colors.green,Colors.yellow,Colors.red], categoryPercentage:0.6, barPercentage:0.7 }]},
  options:{ responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{ display:false }, title:{ display:true, text:'Hours by Color'},
    tooltip:{ callbacks:{ label:(ctx)=>`${ctx.label}: ${hrsToHMS(ctx.raw)} (${ctx.raw.toFixed(2)} h)` } } },
    scales:{ x:{ title:{ display:true, text:'Color' }, offset:true }, y:{ beginAtZero:true, max:24, ticks:{ stepSize:2 }, title:{ display:true, text:'Hours'} } }
  }
});
const summaryChart = new Chart(document.getElementById('summaryChart').getContext('2d'),{
  type:'doughnut',
  data:{ labels:['Green','Yellow','Red'], datasets:[{ data:[0,0,0], backgroundColor:[Colors.green,Colors.yellow,Colors.red], borderWidth:0 }]},
  options:{ responsive:true, maintainAspectRatio:true, cutout:'70%', plugins:{ legend:{ display:false }, tooltip:{ enabled:false } } }
});

/* ===== STATUS / SUMMARY ===== */
function applyThemeColors(){
  const g=Colors.green, y=Colors.yellow, r=Colors.red;
  lineChart.data.datasets[0].borderColor=g; lineChart.data.datasets[0].backgroundColor=rgba(g,.2);
  lineChart.data.datasets[1].borderColor=y; lineChart.data.datasets[1].backgroundColor=rgba(y,.2);
  lineChart.data.datasets[2].borderColor=r; lineChart.data.datasets[2].backgroundColor=rgba(r,.2);
  pieChart.data.datasets[0].backgroundColor=[g,y,r];
  barChart.data.datasets[0].backgroundColor=[g,y,r];
  summaryChart.data.datasets[0].backgroundColor=[g,y,r];
  lineChart.update(); pieChart.update(); barChart.update(); summaryChart.update();
}
function updateSummary(seconds){
  const g=seconds.green||0, y=seconds.yellow||0, r=seconds.red||0, total=g+y+r;
  const percent = total>0 ? ((g/total)*100).toFixed(1) : '0.0';
  summaryChart.data.datasets[0].data=[round2(g/3600),round2(y/3600),round2(r/3600)];
  summaryChart.update();
  document.getElementById('summaryText').innerHTML =
    `<div style="font-size:20px;font-weight:700;margin-bottom:5px;">${percent}%</div>
     <div>● <span style="color:${Colors.green}">Green</span>: ${secToHMS(g)}</div>
     <div>● <span style="color:${Colors.yellow}">Yellow</span>: ${secToHMS(y)}</div>
     <div>● <span style="color:${Colors.red}">Red</span>: ${secToHMS(r)}</div>`;
}
function setCurrentStatus(color,label=''){
  const c=normalizeColor(color);
  const map={green:Colors.green,yellow:Colors.yellow,red:Colors.red,unknown:'#9e9e9e'};
  document.getElementById('statusCircle').style.background=map[c]||map.unknown;
  document.getElementById('statusText').textContent=label || (AllowedColors.includes(c)?c.toUpperCase():'');
}

/* ===== SINGLE 1s TICK ===== */
let tickController = null;
let tickTimer = null;

async function refreshAllOnce(){
  if(tickController) tickController.abort();
  tickController = new AbortController();
  const signal = tickController.signal;

  try{
    errBox.textContent = '';
    const ymd = datePick.value || toYMDLocal(new Date());
    info.textContent = `${machineName(ACTIVE)} · ${ymd}`;
    const weekStart = toYMDLocal(startOfWeekSunday(new Date(ymd)));
    const isToday = (ymd === toYMDLocal(new Date()));

    /* 1) Try overview for left-tab dots; if it fails, we still proceed */
    let statusMap = {};
    try{
      const overview = await apiGetOverviewToday({ signal });
      MACHINES.forEach(code=>{
        const item = overview.byCode[code];
        statusMap[code] = item ? item.currentColor : 'unknown';
      });
    }catch(_){}
    renderTabs(statusMap);

    /* 2) Always populate charts from per-machine endpoints (uses CODE) */
    const [daily, weekly, current] = await Promise.all([
      apiGetDaily(ACTIVE, ymd, { signal }),
      apiGetWeekly(ACTIVE, weekStart, { signal }),
      apiGetCurrent(ACTIVE, { signal }).catch(()=>null)
    ]);

    pieChart.data.datasets[0].data=[daily.hours.green,daily.hours.yellow,daily.hours.red]; pieChart.update();
    barChart.data.datasets[0].data=[daily.hours.green,daily.hours.yellow,daily.hours.red]; barChart.update();
    updateSummary(daily.seconds);

    lineChart.data.datasets[0].data=weekly.green;
    lineChart.data.datasets[1].data=weekly.yellow;
    lineChart.data.datasets[2].data=weekly.red;
    lineChart.update();

    setCurrentStatus((current && current.color) || 'unknown', isToday ? 'Live' : '');
  }catch(e){
    if(e.name!=='AbortError') errBox.textContent = e.message;
  }
}

function startPolling(){
  stopPolling();
  tickTimer = setInterval(refreshAllOnce, POLL_MS);
  refreshAllOnce();
}
function stopPolling(){
  if(tickTimer) clearInterval(tickTimer), tickTimer=null;
  if(tickController) tickController.abort(), tickController=null;
}
function manualRefreshAndRestart(){ stopPolling(); startPolling(); }

/* ===== BOOT ===== */
(async function boot(){
  // set date default
  document.getElementById('datePick').value = toYMDLocal(new Date());

  await apiGetColors(); applyThemeColors();
  await apiGetMachines();       // ← gets CODE + NAME from DB
  if (!ACTIVE) ACTIVE = MACHINES[0];
  loadState();                  // resolve ACTIVE/date using MACHINES
  saveState();                  // sync URL + storage
  renderTabs();                 // draw tabs + bottom preview
  info.textContent = `${machineName(ACTIVE)} · ${datePick.value}`;
  startPolling();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CNC1 Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background: #f0f0f0; height:100vh; overflow:hidden; }
  .container { display: flex; height:100vh; flex-direction: row; }

  /* Sidebar */
  .sidebar { background: #787878; width: 180px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 10px 0; }
  .menu-item { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background 0.2s; font-size: 16px; }
  .menu-item:hover { background: #454545; }

  /* Dashboard */
  .dashboard { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; height:100%; box-sizing:border-box; overflow:hidden; }
  .top-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-start; }
  .date-picker { background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); max-width: 300px; }
  .date-picker label { margin-right: 10px; font-weight: bold; }
  input[type="date"] { padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; }
  .chart-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex:1; display:flex; flex-direction:column; justify-content:center; }
  .line-status-row { display: flex; gap: 15px; flex:1; }
  .status-box { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 100px; }
  .status-circle { width: 40px; height: 40px; border-radius: 50%; background: #4CAF50; margin-top: 10px; }

  /* Bottom row */
  .dashboard-charts { display: flex; gap: 15px; flex:1; overflow:hidden; }
  .dashboard-charts .pie-wrapper { flex: 0.8; display: flex; align-items: center; justify-content: center; }
  .dashboard-charts .pie-wrapper canvas { max-width: 100% !important; max-height: 100% !important; }
  .dashboard-charts .other-charts { flex: 2; display: flex; gap: 15px; }
  .summary-text { margin-top:10px; text-align:center; font-size:14px; line-height:1.4; }

  @media (max-width: 768px) {
    .container { flex-direction: column; }
    .sidebar { flex-direction: row; width: 100%; height: auto; }
    .menu-item { flex: 1; padding: 15px 0; font-size: 14px; }
    .top-row { flex-direction: column; }
    .line-status-row { flex-direction: column; }
    .date-picker { max-width: 100%; }
    .dashboard-charts { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="menu-item" onclick="location.href='cnc1.html'">CNC1</div>
    <div class="menu-item" onclick="location.href='cnc2.html'">CNC2</div>
    <div class="menu-item" onclick="location.href='cnc3.html'">CNC3</div>
    <div class="menu-item" onclick="location.href='cnc4.html'">CNC4</div>
  </aside>

  <main class="dashboard">
    <div class="top-row">
      <div class="date-picker">
        <label for="dateSelect">Select Date:</label>
        <input type="date" id="dateSelect">
      </div>
      <div class="line-status-row">
        <div class="chart-container" style="flex:3; min-width:250px; height:100%; margin-right:10px;">
          <canvas id="lineChart"></canvas>
        </div>
        <div class="status-box" style="flex:0.7;">
          <h4>Current Status</h4>
          <div id="towerStatus" class="status-circle"></div>
        </div>
      </div>
    </div>

    <div class="dashboard-charts">
      <div class="chart-container pie-wrapper">
        <canvas id="pieChart"></canvas>
      </div>
      <div class="other-charts">
        <div class="chart-container" style="flex:1.5;">
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-container" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
          <canvas id="summaryChart" style="max-width:150px; max-height:150px;"></canvas>
          <div id="summaryText" class="summary-text"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
// ==================== Charts ====================
const weeklyData = {
  labels:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
  datasets:[
    { label:'Green', data:[5,6,7,5.5,6,7.5,6], borderColor:'#4CAF50', backgroundColor:'rgba(76,175,80,0.2)', tension:0.3 },
    { label:'Yellow', data:[1,1.5,1,2,1.2,1,0.8], borderColor:'#FFC107', backgroundColor:'rgba(255,193,7,0.2)', tension:0.3 },
    { label:'Red', data:[0.5,0.8,0.6,0.7,0.5,0.4,0.6], borderColor:'#F44336', backgroundColor:'rgba(244,67,54,0.2)', tension:0.3 }
  ]
};
const lineChart = new Chart(document.getElementById('lineChart').getContext('2d'), {
  type:'line',
  data: weeklyData,
  options:{
    responsive:true,
    plugins:{ legend:{ position:'top' }, title:{ display:true, text:'Tower Light Hours per Week' } },
    scales:{ y:{ beginAtZero:true, max:24, ticks:{ stepSize:2 }, title:{ display:true, text:'Hours'} }, x:{ title:{ display:true, text:'Day of Week'} } }
  }
});

const pieChart = new Chart(document.getElementById('pieChart').getContext('2d'), {
type:'pie',
data:{ labels:['Green','Yellow','Red','Blue','Off'], datasets:[{ data:[0,0,0,0,0], backgroundColor:[COLORS.green,COLORS.yellow,COLORS.red,COLORS.blue,COLORS.off], hoverOffset:4 }]},
options:{ responsive:true, plugins:{ legend:{ position:'top' }, title:{ display:true, text:'Tower Light Daily Distribution'} } }
});

const barChart = new Chart(document.getElementById('barChart').getContext('2d'), {
type:'bar',
data:{ labels:['Green','Yellow','Red','Blue','Off'], datasets:[{ label:'Hours', data:[0,0,0,0,0], backgroundColor:[COLORS.green,COLORS.yellow,COLORS.red,COLORS.blue,COLORS.off] }]},
options:{ responsive:true, plugins:{ legend:{ display:false }, title:{ display:true, text:'Tower Light Hours by Color'} }, scales:{ y:{ beginAtZero:true, max:24, ticks:{ stepSize:2 }, title:{ display:true, text:'Hours'} }, x:{ title:{ display:true, text:'Color'} } } }
});

const summaryChart = new Chart(document.getElementById('summaryChart').getContext('2d'), {
type:'doughnut',
data:{ labels:['Green','Yellow','Red','Blue','Off'], datasets:[{ data:[0,0,0,0,0], backgroundColor:[COLORS.green,COLORS.yellow,COLORS.red,COLORS.blue,COLORS.off], borderWidth:0 }]},
options:{ responsive:true, cutout:'70%', plugins:{ legend:{ display:false }, tooltip:{ enabled:false } } }
});

// ==================== Update functions ====================
function updateSummaryWidget(green,yellow,red){
  const total = green+yellow+red;
  const percent = total>0 ? ((green/total)*100).toFixed(1) : 0;
  summaryChart.data.datasets[0].data = [green,yellow,red];
  summaryChart.update();
  document.getElementById('summaryText').innerHTML = 
    `<div style="font-size:20px;font-weight:bold; margin-bottom:5px;">${percent}%</div>
     <div>● <span style="color:#4CAF50">Green</span>: ${green} hours</div>
     <div>● <span style="color:#FFC107">Yellow</span>: ${yellow} hours</div>
     <div>● <span style="color:#F44336">Red</span>: ${red} hours</div>`;
}

function updateDailyCharts(dailyData){
  pieChart.data.datasets[0].data = [dailyData.green,dailyData.yellow,dailyData.red];
  pieChart.update();
  barChart.data.datasets[0].data = [dailyData.green,dailyData.yellow,dailyData.red];
  barChart.update();
  updateSummaryWidget(dailyData.green,dailyData.yellow,dailyData.red);
}

function updateTowerStatus(color){
  const statusCircle = document.getElementById('towerStatus');
  if(color==='green') statusCircle.style.background='#4CAF50';
  else if(color==='yellow') statusCircle.style.background='#FFC107';
  else if(color==='red') statusCircle.style.background='#F44336';
}

// ==================== Real-time & Historical ====================
let isRealTime = true;
let realTimeInterval;

// ฟังก์ชัน Real-time update
function fetchDataAndUpdate() {
  if(isRealTime){
    const currentData = { green: getRandomInt(5,8), yellow: getRandomInt(1,3), red: getRandomInt(0,2) };
    updateDailyCharts(currentData);
    updateTowerStatus(getRandomColor());
  }
}

// Date picker listener
const dateInput = document.getElementById('dateSelect');
dateInput.addEventListener('change', (e)=>{
  const selectedDate = e.target.value;
  if(selectedDate){
    isRealTime = false;
    // ตัวอย่าง historical data
    const historicalData = { green:6, yellow:3, red:1 };
    updateDailyCharts(historicalData);
    updateTowerStatus('green');
  } else {
    isRealTime = true;
  }
});

// เริ่ม Real-time update ทุก 5 วินาที
realTimeInterval = setInterval(fetchDataAndUpdate, 5000);

// ==================== Initial load ====================
updateDailyCharts({ green:6, yellow:4, red:2 });
updateTowerStatus('green');

// Utility
function getRandomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function getRandomColor(){
  const colors = {green:'#4CAF50', yellow:'#FFC107', red:'#F44336', blue:'#2196F3', off:'#9E9E9E'};
  return colors[Math.floor(Math.random()*colors.length)];
}
</script>
</body>
</html>

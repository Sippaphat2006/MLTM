<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>MLTM Dashboard</title>
        <link rel="stylesheet" href="/style.css" />
    </head>
<body>
    <header>
        <h1>MLTM — Today</h1>
        <div id="conn">connecting…</div>
    </header>


    <main>
        <section id="grid" class="grid"></section>
        <section>
            <h2>Timeline (Today)</h2>
            <div id="timeline"></div>
        </section>
    </main>


    <script>
        let etag = null;
        let currentMachine = null;


        const STATE_COLORS = {
            RED: '#e11d48',
            YELLOW:'#f59e0b',
            GREEN: '#22c55e',
            BLUE: '#3b82f6',
            OFF: '#6b7280'
        };


        function fmt(dt) {
            return new Date(dt).toLocaleString();
        }


        function statePill(state) {
        const color = STATE_COLORS[state] || '#6b7280';
        return `<span class="pill" style="background:${color}">${state}</span>`;
        }


        function renderGrid(machines) {
        const el = document.getElementById('grid');
        el.innerHTML = machines.map(m => `
        <div class="tile" data-id="${m.machine_id}">
        <div class="hdr">
        <h3>${m.name} <small>(${m.machine_id})</small></h3>
        ${statePill(m.current_state)}
        </div>
        <div class="meta">
        <div><b>Last change:</b> ${m.last_change_at ? fmt(m.last_change_at) : '-'}</div>
        <div><b>Last seen:</b> ${m.last_seen_at ? fmt(m.last_seen_at) : '-'}</div>
        </div>
        </div>
        `).join('');


        // click to load timeline
        el.querySelectorAll('.tile').forEach(t => t.addEventListener('click', () => {
        currentMachine = t.dataset.id;
        loadTodayTimeline(currentMachine);
        }));
        }


        async function loadTodayTimeline(id) {
        const res = await fetch(`/api/v1/machines/${id}/today`);
        if (!res.ok) return;
        const data = await res.json();
        const segs = data.segments || [];
        const dayStart = new Date();
        dayStart.setHours(0,0,0,0);
        const now = new Date();
        const totalMs = now - dayStart;


        const bars = segs.map(s => {
        const sdt = new Date(s.start_local);
        const edt = new Date(s.end_local);
        const left = ((sdt - dayStart) / totalMs) * 100;
        const width = Math.max(0.5, ((edt - sdt) / totalMs) * 100);
        const color = STATE_COLORS[s.state] || '#6b7280';
        return `<div class="seg" title="${s.state}\n${s.start_local} → ${s.end_local}"
        style="left:${left}%;width:${width}%;background:${color}"></div>`;
        }).join('');


        document.getElementById('timeline').innerHTML = `
        <div class="tl">
        <div class="axis"><span>00:00</span><span>now</span></div>
        <div class="bar">${bars}</div>
        </div>`;
        }


        async function poll() {
        try {
        const res = await fetch('/api/v1/snapshot', {
        headers: etag ? { 'If-None-Match': etag } : {}
        });
        if (res.status === 304) {
        document.getElementById('conn').textContent = 'live (cached)';
        return;
        }
        if (!res.ok) throw new Error(res.statusText);
        etag = res.headers.get('ETag');
        const data = await res.json();
        renderGrid(data.machines);
        document.getElementById('conn').textContent = 'live';
        if (!currentMachine && data.machines[0]) {
        currentMachine = data.machines[0].machine_id;
        loadTodayTimeline(currentMachine);
        }
        } catch (e) {
        document.getElementById('conn').textContent = 'degraded';
        }
        }


        setInterval(poll, 2500);
        poll();
    </script>
</body>
</html>